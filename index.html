<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="icons/icon-512x512.png">
<title>Zekat Takip</title>

<style>
:root {
    --primary:#1e293b;
    --accent:#f59e0b;
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#111827;
}

body.dark{
    --bg:#0f172a;
    --card:#1e293b;
    --text:#f1f5f9;
    --accent:#fbbf24;
}

*{box-sizing:border-box;font-family:Segoe UI,sans-serif}

body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    padding:20px;
    transition:.3s;
}

.container{max-width:700px;margin:auto}

.card{
    background:var(--card);
    padding:25px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    margin-bottom:20px;
}

h1,h2{text-align:center;margin-top:0}

label{font-weight:600;display:block;margin-top:15px}

input{
    width:100%;
    padding:12px;
    margin-top:5px;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:16px;
}

input:focus{
    outline: 2px solid #0ea5e9;
}

input[readonly]{background:#e2e8f0}

button{
    margin-top:15px;
    padding:12px;
    width:100%;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}

.save-btn{background:var(--accent);color:white}
.delete-btn{
    background:#ef4444;
    color:white;
    padding:6px 10px;
    width:auto;
    font-size:13px;
}

.history-item{
    background:rgba(148,163,184,.15);
    padding:12px;
    border-radius:10px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    align-items:center;
}

.total-box{
    font-weight:bold;
    text-align:center;
    color:var(--accent);
    margin-bottom:15px;
}

/* Hamburger */
.hamburger{
    position:fixed;
    top:15px;
    right:20px;
    font-size:26px;
    cursor:pointer;
    z-index:1001;
}

/* Side Panel */
.side-panel{
    position:fixed;
    top:0;
    right:-320px;
    width:300px;
    height:100%;
    background:var(--card);
    box-shadow:-5px 0 20px rgba(0,0,0,.2);
    padding:20px;
    transition:.3s;
    z-index:1000;
    overflow-y:auto;
}

.side-panel.open{right:0}

.overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.4);
    display:none;
    z-index:999;
}

.overlay.show{display:block}

.panel-btn{
    background:#6366f1;
    color:white;
    margin-bottom:10px;
}

.export-btn{background:#10b981}
.import-btn{background:#0ea5e9}

@media(max-width:500px){
    .history-item{flex-direction:column;align-items:flex-start;gap:8px}
}
</style>
</head>
<body>

<div class="hamburger" onclick="togglePanel()">☰</div>
<div class="overlay" onclick="togglePanel()"></div>

<div class="side-panel" id="panel">
<h2>Ayarlar</h2>

<button class="panel-btn" onclick="toggleDarkMode()">Dark Mode Aç/Kapat</button>
<button class="panel-btn export-btn" onclick="exportCSV()">Excel (CSV) Export</button>
<button class="panel-btn export-btn" onclick="exportJSON()">JSON Export</button>
<button class="panel-btn import-btn" onclick="importJSON()">JSON Import</button>

<hr>

<h3>Geçmiş Tarihli Kayıt</h3>
<label>Tarih Seç</label>
<input type="datetime-local" id="customDate">
<button class="panel-btn" onclick="saveRecord(true)">Seçili Tarihle Kaydet</button>

</div>

<div class="container">

<div class="card">
<h1>Zekat Altın Hesaplayıcı</h1>

<label>1 Gram Altın Fiyatı (TL)</label>
<input type="number" id="goldPrice" autocomplete="off">

<label>Bozdurulan TL</label>
<input type="number" id="amountTL" autocomplete="off">

<label>Kaç Gram</label>
<input type="text" id="resultGram" readonly>

<button class="save-btn" onclick="saveRecord()">Kaydet</button>
</div>

<div class="card">
<h2>Geçmiş</h2>
<div style="display:flex;justify-content:center;align-items:center;gap:20px;margin:15px 0;">
    <button onclick="changeYear(-1)">←</button>
    <strong id="currentYearLabel">2026</strong>
    <button onclick="changeYear(1)">→</button>
</div>

<canvas id="zekatChart" height="100"></canvas>
<div class="total-box">
Toplam Gram: <span id="totalGram">0</span>
</div>
<div id="history"></div>
</div>

<script>
const goldPrice=document.getElementById("goldPrice");
const amountTL=document.getElementById("amountTL");
const resultGram=document.getElementById("resultGram");
const historyDiv=document.getElementById("history");
const totalSpan=document.getElementById("totalGram");

function calculate(){
    const g=parseFloat(goldPrice.value);
    const t=parseFloat(amountTL.value);
    if(g>0&&t>0){
        resultGram.value=(t/g).toFixed(4);
    }else resultGram.value="";
}
goldPrice.addEventListener("input",calculate);
amountTL.addEventListener("input",calculate);

function saveRecord(useCustomDate=false){
    if(!resultGram.value){alert("Önce hesaplama yapın");return;}

    let date=new Date();
    if(useCustomDate){
        const custom=document.getElementById("customDate").value;
        if(!custom){alert("Tarih seçin");return;}
        date=new Date(custom);
    }

    const record={
    id:Date.now(),
    goldPrice:goldPrice.value,
    amountTL:amountTL.value,
    gram:parseFloat(resultGram.value),
    date:date.toLocaleString(),
    timestamp: date.getTime() // sıralama için
};

    let records=JSON.parse(localStorage.getItem("zekatRecords"))||[];
    records.push(record);
    localStorage.setItem("zekatRecords",JSON.stringify(records));
    loadHistory();
}

function loadHistory(){
    historyDiv.innerHTML="";
    let records=JSON.parse(localStorage.getItem("zekatRecords"))||[];

    // TARİHE GÖRE SIRALA (yeniden eskiye)
    records.sort((a,b)=> b.timestamp - a.timestamp);

    let total=0;

    records.forEach(r=>{
        total+=r.gram;

        const div=document.createElement("div");
        div.className="history-item";

        div.innerHTML=`
            <div>
                <strong>${r.gram.toFixed(4)} Gram</strong><br>
                Altın Gram Fiyatı: ${r.goldPrice} TL | TL: ${r.amountTL}<br>
                ${r.date}
            </div>
            <button class="delete-btn" onclick="deleteRecord(${r.id})">Sil</button>
        `;

        historyDiv.appendChild(div);
    });

    totalSpan.textContent=total.toFixed(4);

    updateChart(records); // grafik güncelle
}

function deleteRecord(id){
    if(confirm("Silmek istediğinize emin misiniz?")){
        let records=JSON.parse(localStorage.getItem("zekatRecords"))||[];
        records=records.filter(r=>r.id!==id);
        localStorage.setItem("zekatRecords",JSON.stringify(records));
        loadHistory();
    }
}

/* CSV Export */
function exportCSV(){
    let records=JSON.parse(localStorage.getItem("zekatRecords"))||[];
    if(records.length===0){alert("Veri yok");return;}
    let csv="Tarih,Altın Fiyatı,TL,Gram\n";
    records.forEach(r=>{
        csv+=`${r.date},${r.goldPrice},${r.amountTL},${r.gram}\n`;
    });
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="zekat_kayitlari.csv";
    a.click();
}

/* JSON Export */
function exportJSON(){
    let data=localStorage.getItem("zekatRecords");
    if(!data){alert("Veri yok");return;}
    const blob=new Blob([data],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="zekat_backup.json";
    a.click();
}

/* JSON Import */
function importJSON(){
    const input=document.createElement("input");
    input.type="file";
    input.accept=".json";
    input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=function(evt){
            try{
                const data=JSON.parse(evt.target.result);
                localStorage.setItem("zekatRecords",JSON.stringify(data));
                loadHistory();
                alert("Yükleme başarılı");
            }catch{
                alert("Geçersiz JSON dosyası");
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

/* Dark Mode */
function toggleDarkMode(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode",document.body.classList.contains("dark"));
}
if(localStorage.getItem("darkMode")==="true"){
    document.body.classList.add("dark");
}

/* Panel */
function togglePanel(){
    document.getElementById("panel").classList.toggle("open");
    document.querySelector(".overlay").classList.toggle("show");
}

loadHistory();
</script>


<script>
  let chart;
let currentYear = new Date().getFullYear();

function changeYear(direction){
    currentYear += direction;
    document.getElementById("currentYearLabel").textContent = currentYear;
    loadHistory(); // grafiği yeniden üret
}

function updateChart(records){

    // Sadece seçilen yılın verilerini al
    const monthlyTotals = Array(12).fill(0);

    records.forEach(r=>{
        if(!r.timestamp) return; // eski kayıt güvenliği

        const date = new Date(r.timestamp);
        const year = date.getFullYear();
        const month = date.getMonth();

        if(year === currentYear){
            monthlyTotals[month] += r.gram;
        }
    });

    const monthLabels = [
        "Ocak","Şubat","Mart","Nisan","Mayıs","Haziran",
        "Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"
    ];

    const ctx = document.getElementById("zekatChart").getContext("2d");

    if(chart){
        chart.destroy();
    }

    chart = new Chart(ctx,{
        type:"bar",
        data:{
            labels:monthLabels,
            datasets:[{
                label: currentYear + " Aylık Toplam Gram",
                data: monthlyTotals.map(v=>v.toFixed(4)),
                backgroundColor:"rgba(245,158,11,0.7)"
            }]
        },
        options:{
            responsive:true,
            scales:{
                y:{
                    beginAtZero:true
                }
            }
        }
    });
}

// Sayfa açılırken yılı ayarla
document.getElementById("currentYearLabel").textContent = currentYear;
</script>


<!-- customDate inputunu bugünün tarihine ayarlama -->
<script>
  const input = document.getElementById("customDate");
  const today = new Date();
  
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  
  input.value = `${year}-${month}-${day}T12:00`;
</script>

<!-- PWA için Service Worker -->
<!-- PWA için Service Worker kayıt (sw.js ayrı dosyada yer alır) -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker kayıtlı: ', reg))
            .catch(err => console.log('Service Worker hatası: ', err));
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>